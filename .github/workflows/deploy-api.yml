name: Deploy API

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment (staging or prod)"
        required: true
        type: string
      deployment_name:
        description: "Kubernetes deployment name"
        required: true
        type: string
      eks_cluster_name:
        description: "EKS cluster name"
        required: true
        type: string
      aws_region:
        description: "AWS region"
        required: true
        type: string
      ref:
        description: "Git ref to deploy (branch, tag, or commit SHA)"
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy API to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: github.repository == 'refly-ai/refly'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          role-session-name: gha-refly-${{ inputs.environment }}-deploy

      - name: Set Docker tags
        id: docker_tags
        env:
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          REPOSITORY="${REGISTRY}/refly-api"
          IMAGE_TAG="${{ github.sha }}"
          TAGS="${REPOSITORY}:${IMAGE_TAG}"
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            TAGS="${TAGS},${REPOSITORY}:nightly"
          elif [[ "${{ github.ref_name }}" == "stable" ]]; then
            TAGS="${TAGS},${REPOSITORY}:stable"
          fi
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"
          echo "repository=$REPOSITORY" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "deploy_image=${REPOSITORY}:${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Check if image exists in ECR
        id: check_image
        env:
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          if aws ecr describe-images \
            --repository-name refly-api \
            --image-ids imageTag=${{ steps.docker_tags.outputs.image_tag }} \
            --region "$AWS_REGION" \
            --output json > /dev/null 2>&1; then
            echo "Image exists in ECR, skipping build"
            echo "image_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Image does not exist in ECR, will build"
            echo "image_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check_image.outputs.image_exists == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        if: steps.check_image.outputs.image_exists == 'false'
        env:
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${{ steps.docker_tags.outputs.registry }}"

      - name: Build and push image
        if: steps.check_image.outputs.image_exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.docker_tags.outputs.repository }}:buildcache
          cache-to: type=registry,ref=${{ steps.docker_tags.outputs.repository }}:buildcache,mode=max

      - name: Update kubeconfig for EKS cluster
        run: |
          aws eks update-kubeconfig --name ${{ inputs.eks_cluster_name }} --region ${{ inputs.aws_region }}

      - name: Update API deployment image on EKS
        run: |
          kubectl set image deployment/${{ inputs.deployment_name }} refly-api=${{ steps.docker_tags.outputs.deploy_image }} -n refly-app
          kubectl rollout status deployment/${{ inputs.deployment_name }} -n refly-app --timeout=600s
