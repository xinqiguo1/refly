name: Deploy API

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment (staging or prod)"
        required: true
        type: string
      deployment_name:
        description: "Kubernetes deployment name"
        required: true
        type: string
      eks_cluster_name:
        description: "EKS cluster name"
        required: true
        type: string
      aws_region:
        description: "AWS region"
        required: true
        type: string
      ref:
        description: "Git ref to deploy (branch, tag, or commit SHA)"
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy API to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: github.repository == 'refly-ai/refly'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          role-session-name: gha-refly-${{ inputs.environment }}-deploy

      - name: Set Docker tags
        id: docker_tags
        env:
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          REPOSITORY="${REGISTRY}/refly-api"
          IMAGE_TAG="${{ inputs.environment }}-${{ github.sha }}"
          TAGS="${REPOSITORY}:${IMAGE_TAG}"
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"
          echo "repository=$REPOSITORY" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "deploy_image=${REPOSITORY}:${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"
          echo "nightly_tag=nightly-${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Check for existing images
        id: check_image
        env:
          AWS_REGION: ${{ inputs.aws_region }}
          REPO: refly-api
          TARGET_TAG: ${{ steps.docker_tags.outputs.image_tag }}
          NIGHTLY_TAG: ${{ steps.docker_tags.outputs.nightly_tag }}
        run: |
          # 1. Check if target image already exists
          if aws ecr describe-images --repository-name "$REPO" --image-ids imageTag="$TARGET_TAG" --region "$AWS_REGION" > /dev/null 2>&1; then
            echo "Target image $TARGET_TAG already exists, skipping build and copy"
            echo "image_exists=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 2. Check if nightly image exists to copy from
          echo "Checking for nightly image: $NIGHTLY_TAG"
          MANIFEST=$(aws ecr batch-get-image --repository-name "$REPO" --image-ids imageTag="$NIGHTLY_TAG" --region "$AWS_REGION" --query 'images[0].imageManifest' --output text)

          if [ "$MANIFEST" != "None" ] && [ -n "$MANIFEST" ]; then
            echo "Nightly image found. Copying to $TARGET_TAG..."
            if aws ecr put-image --repository-name "$REPO" --image-tag "$TARGET_TAG" --image-manifest "$MANIFEST" --region "$AWS_REGION" > put_image_output.txt 2>&1; then
              echo "✓ Image copied successfully"
              echo "image_exists=true" >> "$GITHUB_OUTPUT"
            else
              echo "✗ Failed to copy image from nightly tag"
              cat put_image_output.txt
              echo "image_exists=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Nightly image not found, will need to build"
            echo "image_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check_image.outputs.image_exists == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        if: steps.check_image.outputs.image_exists == 'false'
        env:
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${{ steps.docker_tags.outputs.registry }}"

      - name: Build and push image
        if: steps.check_image.outputs.image_exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.docker_tags.outputs.repository }}:buildcache
          cache-to: type=registry,ref=${{ steps.docker_tags.outputs.repository }}:buildcache,mode=max

      - name: Update kubeconfig for EKS cluster
        run: |
          aws eks update-kubeconfig --name ${{ inputs.eks_cluster_name }} --region ${{ inputs.aws_region }}

      - name: Update API deployment image on EKS
        run: |
          kubectl set image deployment/${{ inputs.deployment_name }} refly-api=${{ steps.docker_tags.outputs.deploy_image }} -n refly-app
          kubectl rollout status deployment/${{ inputs.deployment_name }} -n refly-app --timeout=600s
