# Fast development Dockerfile - requires pre-built dist
# Usage:
#   1. pnpm build:web  (outside Docker)
#   2. docker build -f apps/web/Dockerfile.dev -t reflyai/refly-web:dev .

FROM nginx:1.27.3-alpine

# Install bash for environment variable substitution
RUN apk add --no-cache bash

# Copy nginx configuration
COPY deploy/docker/nginx.conf /etc/nginx/conf.d/default.conf

# Copy pre-built static files directly
WORKDIR /usr/share/nginx/html

# ARG changes invalidate cache for subsequent layers
ARG CACHEBUST=1
RUN echo "Cache bust: $CACHEBUST"

COPY apps/web/dist .

# Create config.js template (will be processed by envsubst at container startup)
RUN cat << 'EOF' > /usr/share/nginx/html/config.template.js
window.ENV = {
  API_URL: "$API_URL" || undefined,
  COLLAB_URL: "$COLLAB_URL" || undefined,
  STATIC_PUBLIC_ENDPOINT: "$STATIC_PUBLIC_ENDPOINT" || undefined,
  STATIC_PRIVATE_ENDPOINT: "$STATIC_PRIVATE_ENDPOINT" || undefined,
  SUBSCRIPTION_ENABLED: "$SUBSCRIPTION_ENABLED" === "true",
  CANVAS_TEMPLATE_ENABLED: "$CANVAS_TEMPLATE_ENABLED" === "true",
  SENTRY_ENABLED: "$SENTRY_ENABLED" === "true",
  ENV_TAG: "$ENV_TAG" || undefined,
  DEPLOY_TYPE: "$DEPLOY_TYPE" || undefined,
  PUBLIC_CLOUDFLARE_SITE_KEY: "$PUBLIC_CLOUDFLARE_SITE_KEY" || undefined,
};
EOF

# Create entrypoint script
RUN cat << 'EOF' > /docker-entrypoint.sh
#!/bin/bash
set -e

# Generate runtime config.js from template
envsubst < /usr/share/nginx/html/config.template.js > /usr/share/nginx/html/config.js

exec nginx -g "daemon off;"
EOF

RUN chmod +x /docker-entrypoint.sh

EXPOSE 80

ENTRYPOINT ["/docker-entrypoint.sh"]
